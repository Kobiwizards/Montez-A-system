import { useState, useCallback } from 'react'
import { api } from '@/lib/api/client' // âœ… CHANGE THIS

interface UploadFile {
  file: File
  name: string
  size: number
  type: string
  progress: number
  status: 'pending' | 'uploading' | 'success' | 'error'
  error?: string
  url?: string
}

interface UploadOptions {
  onProgress?: (progress: number) => void
  onSuccess?: (url: string) => void
  onError?: (error: string) => void
}

export function useFileUpload() {
  const [files, setFiles] = useState<UploadFile[]>([])
  const [isUploading, setIsUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)

  const addFiles = useCallback((newFiles: File[]) => {
    const uploadFiles: UploadFile[] = newFiles.map(file => ({
      file,
      name: file.name,
      size: file.size,
      type: file.type,
      progress: 0,
      status: 'pending',
    }))

    setFiles(prev => [...prev, ...uploadFiles])
  }, [])

  const removeFile = useCallback((index: number) => {
    setFiles(prev => prev.filter((_, i) => i !== index))
  }, [])

  const clearFiles = useCallback(() => {
    setFiles([])
  }, [])

  const uploadFile = useCallback(async (file: File, endpoint: string, options?: UploadOptions) => {
    const formData = new FormData()
    formData.append('file', file)

    const uploadFile: UploadFile = {
      file,
      name: file.name,
      size: file.size,
      type: file.type,
      progress: 0,
      status: 'uploading',
    }

    setFiles(prev => [...prev, uploadFile])
    setIsUploading(true)

    try {
      const response = await api.upload<any>(endpoint, formData, {
        onUploadProgress: (progressEvent) => {
          const progress = Math.round((progressEvent.loaded * 100) / (progressEvent.total || file.size))
          setUploadProgress(progress)
          options?.onProgress?.(progress)
        },
      })

      // Type cast response
      const data = response as any
      
      if (data.success) {
        const url = data.data?.url || data.data?.fileUrl || data.data
        setFiles(prev => prev.map(f => 
          f.file === file 
            ? { ...f, status: 'success', progress: 100, url }
            : f
        ))
        options?.onSuccess?.(url)
        return { success: true, url }
      } else {
        throw new Error(data.message || 'Upload failed')
      }
    } catch (error: any) {
      setFiles(prev => prev.map(f => 
        f.file === file 
          ? { ...f, status: 'error', error: error.message }
          : f
      ))
      options?.onError?.(error.message)
      return { success: false, error: error.message }
    } finally {
      setIsUploading(false)
    }
  }, [])

  const uploadMultiple = useCallback(async (endpoint: string, options?: UploadOptions) => {
    setIsUploading(true)
    const results = []

    for (const file of files.filter(f => f.status === 'pending')) {
      const result = await uploadFile(file.file, endpoint, options)
      results.push(result)
    }

    setIsUploading(false)
    return results
  }, [files, uploadFile])

  const getFileUrl = useCallback((file: UploadFile) => {
    if (file.url) return file.url
    return URL.createObjectURL(file.file)
  }, [])

  return {
    files,
    isUploading,
    uploadProgress,
    addFiles,
    removeFile,
    clearFiles,
    uploadFile,
    uploadMultiple,
    getFileUrl,
  }
}